<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="canonical" href="https://borg.games/" />

    <link rel="shortcut icon" href="/favicon.svg" sizes="any" type="image/svg+xml" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#0d0d0d">
    <meta name="msapplication-TileColor" content="#101010">
    <meta name="theme-color" content="#000000">

    <title>Games on my PCs - Borg Games</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        a[href] {
            color: white;
        }
    </style>
    <script type="text/javascript">
        !function(v,y,T){var S=v.location,k="script",D="instrumentationKey",C="ingestionendpoint",I="disableExceptionTracking",E="ai.device.",b="toLowerCase",w=(D[b](),"crossOrigin"),N="POST",e="appInsightsSDK",t=T.name||"appInsights",n=((T.name||v[e])&&(v[e]=t),v[t]||function(l){var u=!1,d=!1,g={initialize:!0,queue:[],sv:"6",version:2,config:l};function m(e,t){var n={},a="Browser";return n[E+"id"]=a[b](),n[E+"type"]=a,n["ai.operation.name"]=S&&S.pathname||"_unknown_",n["ai.internal.sdkVersion"]="javascript:snippet_"+(g.sv||g.version),{time:(a=new Date).getUTCFullYear()+"-"+i(1+a.getUTCMonth())+"-"+i(a.getUTCDate())+"T"+i(a.getUTCHours())+":"+i(a.getUTCMinutes())+":"+i(a.getUTCSeconds())+"."+(a.getUTCMilliseconds()/1e3).toFixed(3).slice(2,5)+"Z",iKey:e,name:"Microsoft.ApplicationInsights."+e.replace(/-/g,"")+"."+t,sampleRate:100,tags:n,data:{baseData:{ver:2}}};function i(e){e=""+e;return 1===e.length?"0"+e:e}}var e,n,f=l.url||T.src;function a(e){var t,n,a,i,o,s,r,c,p;u=!0,g.queue=[],d||(d=!0,i=f,r=(c=function(){var e,t={},n=l.connectionString;if(n)for(var a=n.split(";"),i=0;i<a.length;i++){var o=a[i].split("=");2===o.length&&(t[o[0][b]()]=o[1])}return t[C]||(t[C]="https://"+((e=(n=t.endpointsuffix)?t.location:null)?e+".":"")+"dc."+(n||"services.visualstudio.com")),t}()).instrumentationkey||l[D]||"",c=(c=c[C])?c+"/v2/track":l.endpointUrl,(p=[]).push((t="SDK LOAD Failure: Failed to load Application Insights SDK script (See stack for details)",n=i,o=c,(s=(a=m(r,"Exception")).data).baseType="ExceptionData",s.baseData.exceptions=[{typeName:"SDKLoadFailed",message:t.replace(/\./g,"-"),hasFullStack:!1,stack:t+"\nSnippet failed to load ["+n+"] -- Telemetry is disabled\nHelp Link: https://go.microsoft.com/fwlink/?linkid=2128109\nHost: "+(S&&S.pathname||"_unknown_")+"\nEndpoint: "+o,parsedStack:[]}],a)),p.push((s=i,t=c,(o=(n=m(r,"Message")).data).baseType="MessageData",(a=o.baseData).message='AI (Internal): 99 message:"'+("SDK LOAD Failure: Failed to load Application Insights SDK script (See stack for details) ("+s+")").replace(/\"/g,"")+'"',a.properties={endpoint:t},n)),i=p,r=c,JSON&&((o=v.fetch)&&!T.useXhr?o(r,{method:N,body:JSON.stringify(i),mode:"cors"}):XMLHttpRequest&&((s=new XMLHttpRequest).open(N,r),s.setRequestHeader("Content-type","application/json"),s.send(JSON.stringify(i)))))}function i(e,t){d||setTimeout(function(){!t&&g.core||a()},500)}f&&((n=y.createElement(k)).src=f,!(o=T[w])&&""!==o||"undefined"==n[w]||(n[w]=o),n.onload=i,n.onerror=a,n.onreadystatechange=function(e,t){"loaded"!==n.readyState&&"complete"!==n.readyState||i(0,t)},e=n,T.ld<0?y.getElementsByTagName("head")[0].appendChild(e):setTimeout(function(){y.getElementsByTagName(k)[0].parentNode.appendChild(e)},T.ld||0));try{g.cookie=y.cookie}catch(h){}function t(e){for(;e.length;)!function(t){g[t]=function(){var e=arguments;u||g.queue.push(function(){g[t].apply(g,e)})}}(e.pop())}var s,r,o="track",c="TrackPage",p="TrackEvent",o=(t([o+"Event",o+"PageView",o+"Exception",o+"Trace",o+"DependencyData",o+"Metric",o+"PageViewPerformance","start"+c,"stop"+c,"start"+p,"stop"+p,"addTelemetryInitializer","setAuthenticatedUserContext","clearAuthenticatedUserContext","flush"]),g.SeverityLevel={Verbose:0,Information:1,Warning:2,Error:3,Critical:4},(l.extensionConfig||{}).ApplicationInsightsAnalytics||{});return!0!==l[I]&&!0!==o[I]&&(t(["_"+(s="onerror")]),r=v[s],v[s]=function(e,t,n,a,i){var o=r&&r(e,t,n,a,i);return!0!==o&&g["_"+s]({message:e,url:t,lineNumber:n,columnNumber:a,error:i,evt:v.event}),o},l.autoExceptionInstrumented=!0),g}(T.cfg));function a(){T.onInit&&T.onInit(n)}(v[t]=n).queue&&0===n.queue.length?(n.queue.push(a),n.trackPageView({})):a()}(window,document,{
            src: "https://js.monitor.azure.com/scripts/b/ai.2.min.js", // The SDK URL Source
// name: "appInsights", // Global SDK Instance name defaults to "appInsights" when not supplied
// ld: 0, // Defines the load delay (in ms) before attempting to load the sdk. -1 = block page load and add to head. (default) = 0ms load after timeout,
// useXhr: 1, // Use XHR instead of fetch to report failures (if available),
            crossOrigin: "anonymous", // When supplied this will add the provided value as the cross origin attribute on the script tag
// onInit: null, // Once the application insights instance has loaded and initialized this callback function will be called with 1 argument -- the sdk instance (DO NOT ADD anything to the sdk.queue -- As they won't get called)
            cfg: { // Application Insights Configuration
                connectionString: "InstrumentationKey=6b13cef3-903b-4749-9455-7da67a53416a;IngestionEndpoint=https://centralus-2.in.applicationinsights.azure.com/;LiveEndpoint=https://centralus.livediagnostics.monitor.azure.com/"
            }});
    </script>
    <script src="js/insights-log.js"></script>
</head>

<body style="text-align: center; background: #1e1e1e; color: #cedada;">
    <div class="video-container">
        <video autoplay></video>
        <h1 id="game-status"></h1>
        <div class="popup">
            <input type="checkbox" id="popup" checked="checked" style="display: none">
            <label for="popup" class="alert-message"></label>
        </div>
    </div>

    <div id="launcher" style="text-align: initial;">
        <div id="no-pcs" style="display: none;">
            <h2>No PCs connected</h2>
        </div>
        <select id="game-list" style="display: none;" title="My Games"></select>
        <div id="game-details" style="display: none;">
            <h1 id="game-title"></h1>
            <div>
                <button id="launch-button" type="button">Play</button>
                <select id="game-pc"></select>
                <span id="support-status">this game is not supported</span>
            </div>
            <div id="game-running"></div>
        </div>
    </div>

    <h3 style="display: inline-block;"><a href="/about">Â© Borg Queen, LLC 2023</a></h3>

    <script src="https://alcdn.msauth.net/browser/2.38.2/js/msal-browser.min.js"
        integrity="sha384-hhkHFODse2T75wPL7oJ0RZ+0CgRa74LNPhgx6wO6DMNEhU3/fSbTZdVzxsgyUelp"
        crossorigin="anonymous"></script>
    <script type="module">
        import * as util from './js/streaming-client/src/util.js';

        import { Client } from './js/streaming-client/src/client.js';
        import { ClientAPI } from './js/client-api.js';
        import { configureRTC } from "./js/codecs.js";
        import { MY as OneDrive } from "./js/onedrive.js";
        import { OneDriveRunningGames } from './js/drive-gamefs.js';
        import { OneDriveSignal } from './js/drive-link.js';
        import { OneDrivePersistence } from "./js/drive-persistence.js";
        import { GameID } from './js/gid.js';
        import { getIceServers, updateIceServers, getConnectionType } from './js/ice.js';
        import { Launcher } from './js/launcher.js';
        import { Session } from "./js/session.js";

        import * as My from "./js/my.js";

        const clientApi = new ClientAPI();
        const launcherUI = document.getElementById('launcher');
        const gameList = document.getElementById('game-list');
        const status = document.getElementById('game-status');
        const popup = document.getElementById('popup');
        const popupContent = document.querySelector('.alert-message');
        let initiatedAt = 0;
        let newGame = false;
        let game = "";

        function runClient(pc, signalFactory, element, sessionId, timeout) {
            return new Promise(async (resolve) => {
                const iceServers = getIceServers();
                //set up client object with an event callback: gets connect, status, chat, and shutter events
                const client = new Client(clientApi, signalFactory, element, (event) => {
                    console.log('EVENT', event);

                    switch (event.type) {
                    case 'exit':
                        document.removeEventListener('keydown', hotkeys, true);
                        resolve(event.code);
                        break;
                    case 'status':
                        status.innerText = event.msg;
                        if (!event.msg) {
                            const connectionType = getConnectionType(client.rtc.rtc);
                            if (connectionType === 'relay') {
                                popupContent.innerText = '! slow connection due to a firewall';
                                popup.checked = false;
                            }
                            if (appInsights) {
                                appInsights.trackEvent({
                                    name: 'connected',
                                    properties: {
                                        type: connectionType,
                                    },
                                });
                                appInsights.trackMetric({
                                    name: 'connectTime',
                                    average: performance.now() - initiatedAt,
                                    properties: {
                                        type: connectionType,
                                        newGame: newGame,
                                        game: game,
                                    },
                                });
                            }
                        }
                        break;
                    }
                }, async (name, channel) => {
                    switch (name) {
                    case 'control':
                        await Session.waitForCommandRequest(channel);
                        channel.send(sessionId);
                        await Session.waitForCommandRequest(channel);
                        break;
                    case 'persistence':
                        const persistence = new OneDrivePersistence(channel);
                        break;
                    }
                }, iceServers);
                client.configureRTC = configureRTC;
                //set up useful hotkeys that call client methods: destroy can also be used to cancel pending connection
                const hotkeys = (event) => {
                    event.preventDefault();

                    if (event.code === 'Backquote' && event.ctrlKey && event.altKey) {
                        client.destroy(0);
                    } else if (event.code === 'Enter' && event.ctrlKey && event.altKey) {
                        util.toggleFullscreen(client.element);
                    }
                };
                document.addEventListener('keydown', hotkeys, true);

                try {
                    const offer = await OneDriveSignal.getServerOffer(pc, timeout);

                    await Promise.race([
                        timeout,
                        client.connect(offer.session, offer.sdp, {
                            encoder_bitrate: parseInt(localStorage.getItem('encoder_bitrate')) || 1,
                            app_ss_endpoint: 'localhost',
                            app_ss_port: 7173,
                        })]);
                } catch (e) {
                    if (e.message === 'cancelled')
                        client.destroy(0);
                    resolve(e);
                }
            });
        }

        async function launch(pc, exe, sessionId) {
            const signalFactory = (onFatal) => {
                return new OneDriveSignal(pc, onFatal);
            };

            const container = document.querySelector('.video-container');
            const element = document.querySelector('video');

            launcherUI.style.display = 'none';
            container.style.display = 'block';

            const timeout = util.timeout(1000 /*s*/ * 60 /*m*/ * 3);

            try {
                const launch = !sessionId;
                if (!sessionId)
                    sessionId = crypto.randomUUID();
                newGame = launch;
                game = exe;
                initiatedAt = performance.now();
                status.innerText = 'looking for the node...';
                window.history.pushState('session', '', `#session=${sessionId}`);
                window.addEventListener('popstate', cancel);
                let cancelled = false;

                function cancel() {
                    timeout.reject('cancelled');
                    cancelled = true;
                }

                try {
                    const run = await Promise.all([
                        runClient(pc, signalFactory, element, exe + '\\' + sessionId, timeout),
                        launch
                            ? OneDriveRunningGames.launch(pc, exe, sessionId, timeout)
                            : OneDriveRunningGames.assertRunning(pc, exe, sessionId, timeout)
                    ]);
                    const code = run[0];

                    if (!cancelled)
                        window.history.back();

                    if (code !== 0 && code !== 'cancelled' && (!(code instanceof Error && code.message === 'cancelled')))
                        alert(`Exit code: ${code}`);
                } finally {
                    window.removeEventListener('popstate', cancel);
                }
            } catch (e) {
                console.error(e);
                alert(e);
            } finally {
                popup.checked = true;

                launcherUI.style.display = '';
                container.style.display = '';

                element.src = '';
                element.load();

                Launcher.selectGame(Launcher.selectedGame.offers[0].Uri);
            }
        }

        async function reloadGameList() {
            gameList.innerHTML = '';
            gameList.size = 0;

            const response = await OneDrive.makeRequest('special/approot:/PCs:/children');
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            const json = await response.json();
            const items = json.value;
            for (const item of items) {
                if (!item.hasOwnProperty('folder')) continue;
                await My.getGames(item.name, gameList);
            }

            const noPCs = document.getElementById('no-pcs');
            if (items.length === 0) {
                noPCs.style.display = 'block';
                gameList.style.display = 'none';
                setTimeout(reloadGameList, 30*1000);
            } else {
                noPCs.style.display = 'none';
                gameList.style.display = 'block';
            }

            if (gameList.options.length === 0) {
                Launcher.selectGame(null);
            } else {
                Launcher.selectGame(gameList.options[0].value);
            }
        }

        async function main() {
            updateIceServers().catch(console.error);

            Launcher.launch = launch;
            Launcher.initialize(My.Games.games);

            await OneDrive.login(true);

            await OneDrive.ensureBorgTag();

            await reloadGameList();
        }

        main();
    </script>
</body>

</html>